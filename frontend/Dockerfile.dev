# ============================================================================
# Development Dockerfile - Security-by-design
# ============================================================================
# Security: Use specific version tags and update regularly to patch vulnerabilities
# Check for updates: docker scout cves node:24-alpine
FROM node:24-alpine

# Security & Compliance: Metadata labels
# These labels help identify development images
LABEL org.opencontainers.image.title="LexOrbital FrontRing (Development)"
LABEL org.opencontainers.image.description="LexOrbital FrontRing - Development environment"
LABEL org.opencontainers.image.vendor="LexOrbital"
LABEL security.scanning="enabled"

WORKDIR /app

# Security: Enable corepack for pnpm with specific version
# Pin pnpm version for reproducible builds (update regularly for security patches)
RUN corepack enable && corepack prepare pnpm@10.23.0 --activate

# Security: Create non-root user for development
# Using fixed UID/GID for consistency with production
RUN addgroup -g 1001 -S appuser && \
    adduser -S -u 1001 -G appuser appuser

# Security: Copy monorepo root files first for better layer caching
# This allows Docker to cache the dependency installation layer
# For pnpm workspaces, we need the root package.json, pnpm-lock.yaml, and pnpm-workspace.yaml
# We copy to /app (root) to maintain monorepo structure
COPY --chown=appuser:appuser package.json pnpm-lock.yaml pnpm-workspace.yaml /app/
# Copy workspace package.json and source code
# Note: In dev, we copy code before install to avoid conflicts with node_modules
# The code will be overridden by volume mount anyway
COPY --chown=appuser:appuser frontend /app/frontend

# Security: Install dependencies with frozen lockfile
# This ensures consistent dependency versions across environments
# pnpm will install dependencies for all workspaces defined in pnpm-workspace.yaml
# --ignore-scripts: Skip lifecycle scripts (like husky install) that are not needed in Docker
RUN pnpm install --frozen-lockfile --ignore-scripts

# Change to frontend directory for CMD
WORKDIR /app/frontend

# Security: Switch to non-root user
# This limits the impact of potential security vulnerabilities
USER appuser

# Security: Expose port
# Port 3000 is the default Vite development server port
EXPOSE 3000

# Security: Run Vite dev server with host binding for Docker
# --host 0.0.0.0 is required for Docker networking
# Note: This binds to all interfaces - ensure proper firewall rules in production
# Note: In production, use the production Dockerfile with nginx
# Vite handles SIGTERM gracefully for proper container shutdown
CMD ["pnpm", "dev", "--host", "0.0.0.0"]
